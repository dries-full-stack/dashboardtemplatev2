<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Abonnement activeren</title>
    <meta name="description" content="Branded checkout pagina voor dashboard abonnementen." />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap');

      :root {
        --bg: #f3f8ff;
        --ink: #172844;
        --muted: #5d7494;
        --line: #d8e3f0;
        --card: #ffffff;
        --primary: #1a3f71;
        --primary-soft: #e8f0fa;
        --accent: #18b6ac;
        --shadow: 0 22px 52px rgba(18, 45, 82, 0.14);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 12% 12%, rgba(24, 182, 172, 0.2), transparent 34%),
          radial-gradient(circle at 84% 18%, rgba(26, 63, 113, 0.18), transparent 30%),
          linear-gradient(170deg, #f9fbff 0%, var(--bg) 100%);
        display: grid;
        place-items: center;
        padding: 24px;
      }

      .card {
        width: min(860px, 100%);
        border: 1px solid var(--line);
        border-radius: 24px;
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        box-shadow: var(--shadow);
        overflow: hidden;
        position: relative;
      }

      .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
      }

      .wrap {
        padding: 32px 28px 24px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 800;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        color: #0f6b66;
        border: 1px solid #bdebe7;
        background: #def7f5;
        padding: 8px 12px;
      }

      h1 {
        margin: 16px 0 8px;
        font-size: clamp(24px, 5vw, 36px);
        line-height: 1.08;
        letter-spacing: -0.02em;
      }

      p {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
      }

      .checkout-shell {
        margin-top: 22px;
        border: 1px solid var(--line);
        border-radius: 18px;
        background: var(--card);
        padding: 18px;
      }

      .checkout-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
      }

      .checkout-title {
        font-size: 15px;
        font-weight: 800;
        color: var(--ink);
      }

      .checkout-meta {
        font-size: 12px;
        color: #5f7ca0;
        background: var(--primary-soft);
        border: 1px solid #d0def1;
        border-radius: 999px;
        padding: 6px 10px;
        white-space: nowrap;
      }

      .buy-root {
        display: grid;
        place-items: center;
        min-height: 90px;
      }

      .empty {
        border: 1px dashed #c8d6e8;
        border-radius: 14px;
        padding: 14px;
        font-size: 13px;
        color: #6b83a4;
        background: #f9fbfe;
      }

      .inline-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 44px;
        padding: 0 16px;
        border-radius: 12px;
        border: 1px solid var(--primary);
        background: var(--primary);
        color: #fff;
        text-decoration: none;
        font-size: 14px;
        font-weight: 700;
      }

      .hint {
        margin-top: 10px;
        font-size: 12px;
        color: #6d86a6;
      }

      @media (max-width: 700px) {
        .wrap {
          padding: 24px 20px 18px;
        }

        .checkout-header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <main class="card" role="main">
      <div class="wrap">
        <div class="badge">Veilige betaling via Stripe</div>
        <h1 id="title">Activeer je dashboarding abonnement</h1>
        <p id="subtitle">Kies je plan en rond je betaling af. Na betaling ga je terug naar je dashboard.</p>

        <section class="checkout-shell">
          <div class="checkout-header">
            <div class="checkout-title">Checkout</div>
            <div class="checkout-meta">Hosted by Stripe</div>
          </div>
          <div id="buy-root" class="buy-root">
            <div class="empty">Stripe buy button wordt geladen...</div>
          </div>
          <p id="checkout-hint" class="hint"></p>
        </section>

      </div>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const checkoutHint = document.getElementById('checkout-hint');

      const normalizeSlug = (value) =>
        String(value || '')
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9-]+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '');

      const parseConfig = (raw) => {
        const config = raw && typeof raw === 'object' ? raw : {};
        const defaults = config.defaults && typeof config.defaults === 'object' ? config.defaults : {};
        const profiles = config.profiles && typeof config.profiles === 'object' ? config.profiles : {};
        return { defaults, profiles };
      };

      const getProfileFromConfig = (slug, config) => {
        if (!slug) return null;
        const profile = config.profiles[slug];
        return profile && typeof profile === 'object' ? profile : null;
      };

      const readText = (value) => {
        if (value === null || value === undefined) return '';
        const text = String(value).trim();
        return text || '';
      };

      const pickFirst = (...values) => {
        for (const value of values) {
          const text = readText(value);
          if (text) return text;
        }
        return '';
      };

      const loadBillingConfig = async () => {
        try {
          const response = await fetch('/billing-clients.json', { cache: 'no-store' });
          if (!response.ok) return { defaults: {}, profiles: {} };
          const json = await response.json();
          return parseConfig(json);
        } catch (_error) {
          return { defaults: {}, profiles: {} };
        }
      };

      const withClientReference = (url, clientReferenceId) => {
        if (!url || !clientReferenceId) return url;
        try {
          const parsed = new URL(url);
          if (!parsed.searchParams.get('client_reference_id')) {
            parsed.searchParams.set('client_reference_id', clientReferenceId);
          }
          return parsed.toString();
        } catch (_error) {
          return url;
        }
      };

      const mountBuyButton = (buyButtonId, publishableKey, clientReferenceId, buyRoot) => {
        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://js.stripe.com/v3/buy-button.js';
        script.onload = () => {
          buyRoot.innerHTML = '';
          const button = document.createElement('stripe-buy-button');
          button.setAttribute('buy-button-id', buyButtonId);
          button.setAttribute('publishable-key', publishableKey);
          if (clientReferenceId) {
            button.setAttribute('client-reference-id', clientReferenceId);
          }
          buyRoot.appendChild(button);
        };
        script.onerror = () => {
          buyRoot.innerHTML = '<div class="empty">Kon Stripe buy button niet laden. Gebruik de directe betaallink.</div>';
        };
        document.head.appendChild(script);
      };

      const buildSeatsSetupUrl = (clientSlug, query) => {
        const url = new URL('/billing-seats-setup.html', window.location.origin);
        if (clientSlug) {
          url.searchParams.set('client', clientSlug);
        }

        const passthroughParams = [
          'company',
          'title',
          'subtitle',
          'return_to',
          'function_url',
          'card_only',
          'selected_dashboards',
          'prefill_seats',
          'lock_seats',
          'min',
          'max',
          'seats_price_hint',
          'seats_price_per_rep',
          'seats_price_currency',
          'seats_price_interval'
        ];
        for (const key of passthroughParams) {
          const value = readText(query.get(key));
          if (value) {
            url.searchParams.set(key, value);
          }
        }
        return url.toString();
      };

      const init = async () => {
        const config = await loadBillingConfig();
        const clientSlug = normalizeSlug(params.get('client') || params.get('slug') || '');
        const profile = getProfileFromConfig(clientSlug, config);

        const title = pickFirst(params.get('title'), profile?.title, 'Activeer je dashboarding abonnement');
        const subtitle = pickFirst(
          params.get('subtitle'),
          profile?.subtitle,
          config.defaults.subtitle,
          'Kies je plan en rond je betaling af. Na betaling ga je terug naar je dashboard.'
        );
        const buyButtonId = pickFirst(params.get('buy_button_id'), profile?.buy_button_id, config.defaults.buy_button_id);
        const publishableKey = pickFirst(params.get('pk'), profile?.pk, config.defaults.pk);
        const paymentLink = pickFirst(params.get('payment_link'), profile?.payment_link, config.defaults.payment_link);
        const clientReferenceId = pickFirst(
          params.get('client_reference_id'),
          profile?.client_reference_id,
          clientSlug
        );
        const trackedPaymentLink = withClientReference(paymentLink, clientReferenceId);
        const billingFlow = pickFirst(params.get('billing_flow'), profile?.billing_flow, config.defaults.billing_flow).toLowerCase();

        if (billingFlow === 'seats_setup') {
          window.location.replace(buildSeatsSetupUrl(clientSlug, params));
          return;
        }

        document.getElementById('title').textContent = title;
        document.getElementById('subtitle').textContent = subtitle;

        if (clientSlug) {
          checkoutHint.textContent = profile
            ? `Klantprofiel: ${clientSlug}`
            : `Geen profiel gevonden voor slug "${clientSlug}". Gebruik query parameters of voeg de klant toe in billing-clients.json.`;
        }

        const buyRoot = document.getElementById('buy-root');

        const hasPaymentLink = trackedPaymentLink && trackedPaymentLink.startsWith('https://');

        if (buyButtonId && publishableKey) {
          mountBuyButton(buyButtonId, publishableKey, clientReferenceId, buyRoot);
        } else if (hasPaymentLink) {
          buyRoot.innerHTML = `<a class="inline-link" href="${trackedPaymentLink}" target="_blank" rel="noopener noreferrer">Open beveiligde Stripe checkout</a>`;
        } else {
          buyRoot.innerHTML = '<div class="empty">Geen geldige betaalgegevens gevonden voor deze klant.</div>';
        }
      };

      init();
    </script>
  </body>
</html>
